<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Process API Visualization</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const ProcessAPIVisualization = () => {
      const [step, setStep] = useState(0);
      const [isPlaying, setIsPlaying] = useState(false);
      const [speed, setSpeed] = useState(1500);

      const codeLines = [
        { num: 7, code: 'int main(int argc, char *argv[]) {' },
        { num: 8, code: '  printf("hello (pid:%d)\\n", getpid());' },
        { num: 9, code: '  int rc = fork();' },
        { num: 10, code: '  if (rc < 0) {' },
        { num: 11, code: '    fprintf(stderr, "fork failed\\n");' },
        { num: 12, code: '    exit(1);' },
        { num: 13, code: '  } else if (rc == 0) { // child' },
        { num: 14, code: '    printf("child (pid:%d)\\n", getpid());' },
        { num: 15, code: '    char *myargs[3];' },
        { num: 16, code: '    myargs[0] = strdup("wc");' },
        { num: 17, code: '    myargs[1] = strdup("p3.c");' },
        { num: 18, code: '    myargs[2] = NULL;' },
        { num: 19, code: '    execvp(myargs[0], myargs);' },
        { num: 20, code: '    printf("this shouldn\'t print");' },
        { num: 21, code: '  } else { // parent' },
        { num: 22, code: '    int rc_wait = wait(NULL);' },
        { num: 23, code: '    printf("parent of %d ...\\n", rc);' },
        { num: 24, code: '  }' },
        { num: 25, code: '  return 0;' },
        { num: 26, code: '}' },
      ];

      const steps = [
        {
          title: "Program Start",
          description: "OS loads program into memory, sets PC to main()",
          parent: { pc: 7, state: "RUNNING", rc: null, code: "p3.c" },
          child: null,
          output: [],
          highlight: "OS creates process entry, allocates memory, begins at main()"
        },
        {
          title: "Print Hello",
          description: "Parent prints its PID (29383)",
          parent: { pc: 8, state: "RUNNING", rc: null, code: "p3.c" },
          child: null,
          output: ["hello (pid:29383)"],
          highlight: "getpid() returns the process identifier assigned by OS"
        },
        {
          title: "Calling fork()",
          description: "fork() system call about to execute",
          parent: { pc: 9, state: "RUNNING", rc: null, code: "p3.c" },
          child: null,
          output: ["hello (pid:29383)"],
          highlight: "fork() traps into kernel to create a new process"
        },
        {
          title: "fork() Creates Child",
          description: "OS creates almost exact copy of parent",
          parent: { pc: 9, state: "READY", rc: 29384, code: "p3.c" },
          child: { pc: 9, state: "READY", rc: 0, code: "p3.c (copy)" },
          output: ["hello (pid:29383)"],
          highlight: "fork() returns TWICE! Parent gets child PID, child gets 0"
        },
        {
          title: "Scheduler Decides",
          description: "CPU scheduler picks child to run first",
          parent: { pc: 10, state: "READY", rc: 29384, code: "p3.c" },
          child: { pc: 10, state: "RUNNING", rc: 0, code: "p3.c (copy)" },
          output: ["hello (pid:29383)"],
          highlight: "Non-determinism! Either process could run first"
        },
        {
          title: "Child Checks rc",
          description: "rc == 0, takes child branch",
          parent: { pc: 10, state: "READY", rc: 29384, code: "p3.c" },
          child: { pc: 13, state: "RUNNING", rc: 0, code: "p3.c (copy)" },
          output: ["hello (pid:29383)"],
          highlight: "Return value of fork() determines which branch"
        },
        {
          title: "Child Prints",
          description: "Child announces itself",
          parent: { pc: 10, state: "READY", rc: 29384, code: "p3.c" },
          child: { pc: 14, state: "RUNNING", rc: 0, code: "p3.c (copy)" },
          output: ["hello (pid:29383)", "child (pid:29384)"],
          highlight: "Child has its own PID (29384)"
        },
        {
          title: "Child Sets Up Args",
          description: "Prepares arguments for exec()",
          parent: { pc: 10, state: "READY", rc: 29384, code: "p3.c" },
          child: { pc: 18, state: "RUNNING", rc: 0, code: "p3.c (copy)" },
          output: ["hello (pid:29383)", "child (pid:29384)"],
          highlight: "argv array must be NULL-terminated"
        },
        {
          title: "Child Calls exec()",
          description: "execvp() about to replace child's code",
          parent: { pc: 10, state: "READY", rc: 29384, code: "p3.c" },
          child: { pc: 19, state: "RUNNING", rc: 0, code: "p3.c (copy)" },
          output: ["hello (pid:29383)", "child (pid:29384)"],
          highlight: "exec() transforms current process, doesn't create new one"
        },
        {
          title: "exec() Transforms Child",
          description: "OS loads 'wc', replaces code/stack/heap",
          parent: { pc: 10, state: "READY", rc: 29384, code: "p3.c" },
          child: { pc: "wc:main", state: "RUNNING", rc: null, code: "wc", isTransformed: true },
          output: ["hello (pid:29383)", "child (pid:29384)"],
          highlight: "Same PID (29384), completely different program!"
        },
        {
          title: "wc Runs",
          description: "'wc' counts lines, words, bytes",
          parent: { pc: 10, state: "READY", rc: 29384, code: "p3.c" },
          child: { pc: "wc:...", state: "RUNNING", rc: null, code: "wc", isTransformed: true },
          output: ["hello (pid:29383)", "child (pid:29384)", "  29  107  1030 p3.c"],
          highlight: "Line 20 never executes - exec() replaced all code!"
        },
        {
          title: "Child Exits",
          description: "wc finishes, child becomes ZOMBIE",
          parent: { pc: 10, state: "READY", rc: 29384, code: "p3.c" },
          child: { pc: null, state: "ZOMBIE", rc: null, code: "wc", isTransformed: true },
          output: ["hello (pid:29383)", "child (pid:29384)", "  29  107  1030 p3.c"],
          highlight: "ZOMBIE: finished but parent hasn't called wait()"
        },
        {
          title: "Parent Runs",
          description: "rc > 0, takes parent branch",
          parent: { pc: 21, state: "RUNNING", rc: 29384, code: "p3.c" },
          child: { pc: null, state: "ZOMBIE", rc: null, code: "wc", isTransformed: true },
          output: ["hello (pid:29383)", "child (pid:29384)", "  29  107  1030 p3.c"],
          highlight: "Parent's rc is child's PID (29384)"
        },
        {
          title: "Parent Calls wait()",
          description: "Child already exited, returns immediately",
          parent: { pc: 22, state: "RUNNING", rc: 29384, code: "p3.c" },
          child: { pc: null, state: "ZOMBIE", rc: null, code: "wc", isTransformed: true },
          output: ["hello (pid:29383)", "child (pid:29384)", "  29  107  1030 p3.c"],
          highlight: "wait() reaps zombie, returns child's PID"
        },
        {
          title: "Child Reaped",
          description: "Child's resources freed",
          parent: { pc: 22, state: "RUNNING", rc: 29384, rcWait: 29384, code: "p3.c" },
          child: null,
          output: ["hello (pid:29383)", "child (pid:29384)", "  29  107  1030 p3.c"],
          highlight: "rc_wait = 29384, child process entry removed"
        },
        {
          title: "Parent Prints",
          description: "Confirms wait completed",
          parent: { pc: 23, state: "RUNNING", rc: 29384, rcWait: 29384, code: "p3.c" },
          child: null,
          output: ["hello (pid:29383)", "child (pid:29384)", "  29  107  1030 p3.c", "parent of 29384 (rc_wait:29384) (pid:29383)"],
          highlight: "Parent confirms it waited for child"
        },
        {
          title: "Parent Exits",
          description: "Program complete",
          parent: { pc: 25, state: "TERMINATED", rc: 29384, code: "p3.c" },
          child: null,
          output: ["hello (pid:29383)", "child (pid:29384)", "  29  107  1030 p3.c", "parent of 29384 (rc_wait:29384) (pid:29383)"],
          highlight: "fork() creates, exec() transforms, wait() synchronizes"
        },
      ];

      useEffect(() => {
        let interval;
        if (isPlaying && step < steps.length - 1) {
          interval = setInterval(() => {
            setStep(s => Math.min(s + 1, steps.length - 1));
          }, speed);
        } else if (step >= steps.length - 1) {
          setIsPlaying(false);
        }
        return () => clearInterval(interval);
      }, [isPlaying, step, speed]);

      const currentStep = steps[step];

      const stateColors = {
        RUNNING: 'bg-green-500',
        READY: 'bg-yellow-500',
        BLOCKED: 'bg-red-500',
        ZOMBIE: 'bg-purple-500',
        TERMINATED: 'bg-gray-500',
      };

      const ProcessBox = ({ process, label, pid }) => {
        if (!process) {
          return (
            <div className="border-2 border-dashed border-gray-300 rounded p-2 bg-gray-50 h-full min-h-28">
              <div className="flex justify-between text-xs text-gray-400 mb-1">
                <span className="font-bold">{label}</span>
                <span>PID: {pid}</span>
              </div>
              <p className="text-gray-400 text-xs italic">Does not exist</p>
            </div>
          );
        }

        return (
          <div className={`border-2 rounded p-2 h-full min-h-28 ${
            process.state === 'RUNNING' ? 'border-green-500 bg-green-50' : 
            process.state === 'ZOMBIE' ? 'border-purple-500 bg-purple-50' :
            'border-gray-300 bg-white'
          }`}>
            <div className="flex justify-between text-xs mb-1">
              <span className="font-bold">{label}</span>
              <span className="text-gray-600">PID: {pid}</span>
            </div>
            
            <div className="space-y-0.5 text-xs">
              <div className="flex items-center gap-2">
                <span className={`px-1.5 py-0.5 rounded text-white text-xs font-bold ${stateColors[process.state]}`}>
                  {process.state}
                </span>
                <span className="font-mono text-gray-600">
                  PC: {process.pc === null ? '‚Äî' : process.pc}
                </span>
              </div>
              
              <div className="flex gap-3 font-mono text-xs">
                {process.rc !== null && process.rc !== undefined && (
                  <span>rc=<span className="text-blue-600 font-bold">{process.rc}</span></span>
                )}
                {process.rcWait !== undefined && (
                  <span>rc_wait=<span className="text-blue-600 font-bold">{process.rcWait}</span></span>
                )}
              </div>
              
              <div className={`font-mono text-xs px-1 py-0.5 rounded mt-1 ${
                process.isTransformed ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-600'
              }`}>
                code: {process.code}
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="h-screen bg-gray-100 p-2 flex flex-col">
          {/* Controls */}
          <div className="flex items-center justify-between bg-white rounded shadow px-3 py-1.5 mb-2">
            <div className="flex items-center gap-2">
              <button
                onClick={() => setStep(0)}
                className="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm"
              >
                ‚èÆ
              </button>
              <button
                onClick={() => setStep(Math.max(0, step - 1))}
                className="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm disabled:opacity-50"
                disabled={step === 0}
              >
                ‚óÄ
              </button>
              <button
                onClick={() => setIsPlaying(!isPlaying)}
                className={`px-3 py-1 rounded text-white text-sm ${
                  isPlaying ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'
                }`}
              >
                {isPlaying ? '‚è∏' : '‚ñ∂'}
              </button>
              <button
                onClick={() => setStep(Math.min(steps.length - 1, step + 1))}
                className="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm disabled:opacity-50"
                disabled={step === steps.length - 1}
              >
                ‚ñ∂
              </button>
              <input
                type="range"
                min="500"
                max="3000"
                value={speed}
                onChange={(e) => setSpeed(Number(e.target.value))}
                className="w-20"
              />
              <span className="text-xs text-gray-500">{step + 1}/{steps.length}</span>
            </div>
            
            <div className="flex-1 mx-4">
              <span className="font-bold text-sm">{currentStep.title}</span>
              <span className="text-gray-600 text-sm ml-2">‚Äî {currentStep.description}</span>
            </div>
          </div>

          {/* Insight bar */}
          <div className="bg-yellow-50 border-l-4 border-yellow-400 px-3 py-1 mb-2 text-sm">
            üí° {currentStep.highlight}
          </div>

          {/* Main content */}
          <div className="flex-1 flex gap-2 min-h-0">
            {/* Code Panel */}
            <div className="flex-1 bg-gray-900 rounded p-2 font-mono text-sm overflow-auto">
              {codeLines.map((line) => {
                const isParentPC = currentStep.parent?.pc === line.num;
                const isChildPC = currentStep.child?.pc === line.num;
                
                return (
                  <div
                    key={line.num}
                    className={`flex leading-snug ${
                      isParentPC && isChildPC ? 'bg-purple-800' :
                      isParentPC ? 'bg-blue-800' :
                      isChildPC ? 'bg-green-800' : ''
                    }`}
                  >
                    <span className="text-gray-500 w-6 text-right pr-2 select-none">
                      {line.num}
                    </span>
                    <span className="w-4 flex-shrink-0">
                      {isParentPC && isChildPC ? (
                        <span className="text-purple-300">‚áí</span>
                      ) : isParentPC ? (
                        <span className="text-blue-300">‚Üí</span>
                      ) : isChildPC ? (
                        <span className="text-green-300">‚Üí</span>
                      ) : null}
                    </span>
                    <span className={isParentPC || isChildPC ? 'text-white font-bold' : 'text-gray-300'}>
                      {line.code}
                    </span>
                  </div>
                );
              })}
              <div className="mt-2 pt-1 border-t border-gray-700 text-xs text-gray-500 flex gap-4">
                <span><span className="text-blue-300">‚Üí</span> Parent</span>
                <span><span className="text-green-300">‚Üí</span> Child</span>
              </div>
            </div>

            {/* Right panel: processes + terminal */}
            <div className="w-64 flex flex-col gap-2">
              <ProcessBox process={currentStep.parent} label="Parent" pid="29383" />
              <ProcessBox process={currentStep.child} label="Child" pid="29384" />
              
              {/* Terminal */}
              <div className="flex-1 bg-black rounded p-2 font-mono text-xs text-green-400 overflow-auto">
                <div className="text-gray-500">$ ./p3</div>
                {currentStep.output.map((line, i) => (
                  <div key={i}>{line}</div>
                ))}
                {currentStep.parent?.state === 'TERMINATED' && (
                  <div className="text-gray-500">$</div>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ProcessAPIVisualization />);
  </script>
</body>
</html>
